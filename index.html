<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tietoprovinssi Voice-Image-Edit</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <!-- frontend backend communication -->
    <script src="https://cdn.socket.io/4.1.2/socket.io.min.js"></script>
    <!-- font awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <!-- speech bubble font -->
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:ital,wght@1,700&display=swap" rel="stylesheet" />
    <style>
      * {
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Exo", sans-serif;
        background: #070815;
        color: white;
        display: flex;
        flex-direction: column;
        height: 100vh;
        align-items: center;
        overflow: hidden;
      }

      .main-page {
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100%;
        width: calc(100% - 725px);
      }

      #spinner_container {
        position: absolute;
        display: none;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.25);
      }

      .spinner {
        border: 16px solid #f3f3f3;
        border-radius: 50%;
        border-top: 16px solid #3498db;
        width: 120px;
        height: 120px;
        animation: spin 2s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      h1 { text-align: center; font-weight: lighter; margin: 10px; }
      h3 { text-align: center; font-weight: lighter; }
      h5 { text-align: center; font-weight: lighter; }

      .custom-textarea {
        flex: 1;
        margin: 10px;
        padding: 10px;
        color: white;
        background-color: transparent;
        border: 1px solid white;
        border-radius: 5px;
        resize: none;
        font-size: 1em;
        pointer-events: none;
        font-family: "Exo", sans-serif;
        width: 300px;
        height: 75px;
      }

      .arrow { color: white; font-size: 1.5em; white-space: nowrap; }

      .controls-content {
        display: flex;
        flex-direction: row;
        padding: 20px;
        align-items: center;
        justify-content: space-evenly;
        width: 1200px;
      }

      .textareas-container { display: flex; }
      .container { display: flex; align-items: center; justify-content: center; width: 100%; margin: 10px; }
      .input-container { display: flex; flex-direction: column; }
      .flex-center { display: flex; align-items: center; justify-content: center; margin: 4px; }
      .flex-vertical { display: flex; flex-direction: column; }
      .flex-horizontal { display: flex; align-items: center; }

      .gen-image-container {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        width: 100%;
      }

      #generated_image {
        object-fit: contain;
        height: calc(100vh - 475px);
        width: auto;
        border-radius: 8px;
      }

      .mic-status {
        width: 125px;
        color: lightcoral;
        border: 2px solid lightcoral;
        border-radius: 8px;
        padding: 8px;
        display: flex;
        align-items: start;
        flex-direction: column;
      }

      .mic-icon { margin: 0 4px; }
      .rb-input { margin: 0 4px 0 8px; }
      .height-50 { height: 75px; justify-content: space-evenly; }
      .font-bold { font-weight: 600; }

      .gallery {
        padding: 10px;
        display: none;
        flex-wrap: wrap;
        justify-content: space-around;
        overflow-y: auto;
        width: 100%;
        height: 100%;
      }
      .gallery .image-container {
        position: relative;
        margin: 5px;
        flex: 1 1 calc(20% - 10px);
        text-align: center;
        box-sizing: border-box;
      }
      .gallery .image-container img {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 8px;
      }
      .gallery .overlay {
        position: absolute;
        bottom: 5%;
        left: 50%;
        color: white;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 5px;
        transform: translate(-50%, -50%);
        pointer-events: none;
        border-radius: 4px;
      }
      .gallery .download-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      }
      .gallery .download-btn:hover {
        background: rgba(255, 255, 255, 0.8);
        color: black;
      }
      .gallery img:hover {
        cursor: pointer;
        filter: brightness(1.1);
        transform: scale(1.025);
        transition: all 0.25s ease-in-out;
      }
      @media (max-width: 1600px) {
        .gallery .image-container {
          flex: 1 1 calc(25% - 10px);
        }
      }
      @media (max-width: 1200px) {
        .gallery .image-container {
          flex: 1 1 calc(33.333% - 10px);
        }
      }
      @media (max-width: 800px) {
        .gallery .image-container {
          flex: 1 1 calc(50% - 10px);
        }
      }
      @media (max-width: 500px) {
        .gallery .image-container {
          flex: 1 1 calc(100% - 10px);
        }
      }

      #panzoom_parent {
        display: none;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      .node {
        position: absolute;
      }

      .node img {
        width: 100px;
        height: 100px;
        border-radius: 8px;
      }

      .node img:hover {
        cursor: pointer;
        filter: brightness(1.1);
        transform: scale(1.025);
        transition: all 0.25s ease-in-out;
      }
      .node p {
        font-size: 8px;
        line-height: 10px;
        font-weight: bold;
        padding: 3px;
        border: 2px solid white;
        background: #070815;
        width: 48px;
      }

      .gen-image-buttons {
        position: absolute;
        display: flex;
        width: 100%;
        height: 100%;
        pointer-events: none; /* Allow clicks to pass through to image if needed, but buttons need pointer-events: auto */
      }

      .gen-image-buttons button {
        pointer-events: auto;
      }

      .gallery_chart_button .text_image_div {
        width: 45%;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .gallery_chart_button .spacer_div {
        width: 55%;
      }

      .gallery_chart_button {
        position: relative;
        width: 50%;
        border: none;
        padding: 10px;
        background: transparent;
        border-radius: 8px;
        cursor: pointer;
        opacity: 0; /* Hidden by default until hover area */
        color: white;
        font-size: 2.5rem;
        font-weight: bold;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        transition: opacity 0.3s;
      }

      .gen-image-container:hover .gallery_chart_button {
          opacity: 0.25;
      }

      .gallery_chart_button:hover {
        opacity: 0.75 !important;
        background: rgba(255, 255, 255, 0.25);
      }

      .gallery_chart_button img {
        max-width: 100px;
        max-height: 100px;
        object-fit: cover;
        filter: brightness(0) invert(1);
        opacity: 0.75;
      }

      #chart_button img {
        transform: rotate(-90deg);
      }

      .jr-image {
        position: absolute;
        left: 0;
        bottom: 0;
        height: 250px;
        opacity: 1;
      }

      .jr-image:hover {
        cursor: pointer;
        filter: brightness(1.1);
        transform: scale(1.025);
        transition: all 0.25s ease-in-out;
      }

      .hb::before {
        content: "";
        display: block;
        position: absolute;
      }

      .bubble {
        position: absolute;
        color: black;
        border: 0.5vmin solid black;
        border-radius: 100%;
        width: 275px;
        height: 175px;
        left: 75px;
        bottom: 225px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: 1.5rem;
        background: #ffd;
        box-shadow: 0 -0.25vmin, 0 0.125vmin;
        font-family: "Comic Sans", "Comic Neue", sans-serif;
        opacity: 0;
        transition: all 0.5s ease-in-out;
      }

      .bubble::before {
        width: 40%;
        height: 100%;
        bottom: -54%;
        border-radius: 50%;
        left: 10%;
        box-shadow: 0.5vmin 0, 2vmin -0.5vmin #ffd, 2vmin -0.5vmin 0 0.5vmin;
        clip-path: polygon(0% 49%, 150% 48%, 150% 100%, 0% 100%);
        transform: rotate(-3deg);
      }

      #session_info {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 1.2rem;
        font-weight: bold;
      }
    </style>
  </head>
  <body id="body">
    <div class="main-page" id="main_page">
      <div id="session_info">Remaining: --/--</div>

      <img id="logo_image" class="logo-image" src="https://raw.githubusercontent.com/Koodattu/ucs-llm-voice-image-edit/main/assets/gls.png" />
      <div id="speech_bubble" class="bubble hb">Koita vaikka sanoa notta "tees mulle uus kuva tekoälyagentista"</div>
      <img id="jr_image" class="jr-image" src="https://raw.githubusercontent.com/Koodattu/ucs-llm-voice-image-edit/main/assets/gls_wide.png" />
      <h1>Voice Guided AI-Powered Imaging</h1>

      <div class="controls-content">
        <div>
          <div class="flex-horizontal">
            <h3>Microphone:&nbsp;&nbsp;</h3>
            <div id="mic_status_box" class="mic-status">
              <div class="flex-horizontal">
                <i id="mic_icon_closed" class="fa fa-microphone-slash mic-icon" style="display: block"></i>
                <i id="mic_icon_open" class="fa fa-microphone mic-icon" style="display: none"></i>
                <p id="mic_status_txt" class="font-bold">Muted</p>
              </div>
              <label id="mic_help" style="margin: 4px">Hold spacebar</label>
            </div>
          </div>
        </div>
        <div class="input-container height-50">
          <div class="flex-center">
            <h3>Language:&nbsp;</h3>
            <div class="flex-vertical">
              <div>
                <input class="rb-input" type="radio" id="rb_auto" name="rb_lang" checked="true" />
                <label for="rb_auto">Auto</label>
              </div>
              <div>
                <input class="rb-input" type="radio" id="rb_en" name="rb_lang" />
                <label for="rb_en">English</label>
              </div>
              <div>
                <input class="rb-input" type="radio" id="rb_fi" name="rb_lang" />
                <label for="rb_fi">Finnish</label>
              </div>
            </div>
          </div>
        </div>
        <div class="input-container height-50">
          <div class="flex-center">
            <h3>Processing:&nbsp;</h3>
            <div class="flex-vertical">
              <div>
                <input class="rb-input" type="radio" id="rb_cloud" name="rb_model" checked="true" />
                <label for="rb_cloud">Cloud</label>
              </div>
              <div>
                <input class="rb-input" type="radio" id="rb_local" name="rb_model" disabled />
                <label for="rb_local" id="lbl_local">Local (Offline)</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="textareas-container">
        <div class="container">
          <div>
            <h5>STT</h5>
            <h3>Live Transcription</h3>
            <textarea id="transcription" class="custom-textarea" tabindex="-1"></textarea>
          </div>
          <div id="llm_arrows">
            <br />
            <div class="arrow">→</div>
            <div class="arrow">→</div>
            <div class="arrow">→</div>
          </div>
          <div>
            <h5>LLM</h5>
            <h3>Inferred Action</h3>
            <textarea id="llm_response" class="custom-textarea" tabindex="-1"></textarea>
          </div>
        </div>
      </div>

      <div>
        <h5>System Status</h5>
        <h3 id="system_status" class="font-bold">Waiting for connection...</h3>
      </div>

      <div class="gen-image-container">
        <img id="generated_image" src="https://raw.githubusercontent.com/Koodattu/ucs-llm-voice-image-edit/main/assets/canvas.webp" />
        <div class="gen-image-buttons">
          <button id="chart_button" class="gallery_chart_button">
            <div class="text_image_div">
              <p>CHART</p>
              <img src="https://raw.githubusercontent.com/Koodattu/ucs-llm-voice-image-edit/main/assets/tree_chart.png" />
            </div>
            <div class="spacer_div"></div>
          </button>
          <button id="gallery_button" class="gallery_chart_button">
            <div class="spacer_div"></div>
            <div class="text_image_div">
              <p>GALLERY</p>
              <img src="https://raw.githubusercontent.com/Koodattu/ucs-llm-voice-image-edit/main/assets/gallery.webp" />
            </div>
          </button>
        </div>
        <div id="spinner_container">
          <div id="spinner" class="spinner"></div>
        </div>
      </div>
    </div>

    <div class="gallery" id="gallery"></div>

    <div id="panzoom_parent">
      <div class="tree-view" id="tree_view"></div>
    </div>

    <script>
      const socket = io("/kuvagen/socket.io");

      const transcription = document.getElementById("transcription");
      const llm_response = document.getElementById("llm_response");
      const generated_image = document.getElementById("generated_image");
      const spinner_cont = document.getElementById("spinner_container");
      const system_status = document.getElementById("system_status");
      const session_info = document.getElementById("session_info");

      const mic_status_box = document.getElementById("mic_status_box");
      const mic_status_txt = document.getElementById("mic_status_txt");
      const mic_icon_closed = document.getElementById("mic_icon_closed");
      const mic_icon_open = document.getElementById("mic_icon_open");

      const rb_cloud = document.getElementById("rb_cloud");
      const rb_local = document.getElementById("rb_local");
      const lbl_local = document.getElementById("lbl_local");

      let isRecording = false;
      let mediaRecorder;
      let chunks = [];

      // --- Socket Events ---

      socket.on("connect", () => {
        system_status.innerText = "Connected";
      });

      socket.on("disconnect", () => {
        system_status.innerText = "Disconnected";
        rb_local.disabled = true;
        lbl_local.innerText = "Local (Offline)";
      });

      socket.on("session_info", (data) => {
        session_info.innerText = `Remaining: ${data.remaining}/${data.limit}`;
      });

      socket.on("backend_status", (data) => {
        if (data.available) {
          rb_local.disabled = false;
          lbl_local.innerText = "Local (Online)";
        } else {
          rb_local.disabled = true;
          lbl_local.innerText = "Local (Offline)";
          rb_cloud.checked = true;
        }
      });

      socket.on("status", (msg) => {
        system_status.innerText = msg;
        if (msg === "Ready" || msg.includes("error")) {
            spinner_cont.style.display = "none";
        } else {
            spinner_cont.style.display = "flex";
        }
      });

      socket.on("queue_status", (data) => {
        if (data.position >= 0) {
            system_status.innerText = `In Queue: Position ${data.position + 1}`;
            spinner_cont.style.display = "flex";
        } else {
             // Should not happen if logic is correct, but just in case
             system_status.innerText = "Processing...";
        }
      });

      socket.on("error", (msg) => {
        system_status.innerText = "Error: " + msg;
        spinner_cont.style.display = "none";
      });

      socket.on("transcription", (text) => {
        transcription.value = text;
      });
          e.preventDefault();
          startRecording();
        }
      });

      document.addEventListener("keyup", (e) => {
        if (e.code === "Space" && isRecording) {
          e.preventDefault();
          stopRecording();
        }
      });

      async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];

            mediaRecorder.ondataavailable = (e) => {
                chunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: "audio/webm" });
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = () => {
                    const base64data = reader.result.split(",")[1];
                    sendAudio(base64data);
                };
                stream.getTracks().forEach(track => track.stop());
            };

            mediaRecorder.start();
            isRecording = true;
            updateMicUI(true);
        } catch (err) {
            console.error("Mic error:", err);
            system_status.innerText = "Microphone Error";
        }
      }

      function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            updateMicUI(false);
        }
      }

      function updateMicUI(recording) {
        if (recording) {
            mic_status_box.style.borderColor = "lightgreen";
            mic_status_box.style.color = "lightgreen";
            mic_status_txt.innerText = "Recording";
            mic_icon_closed.style.display = "none";
            mic_icon_open.style.display = "block";
        } else {
            mic_status_box.style.borderColor = "lightcoral";
            mic_status_box.style.color = "lightcoral";
            mic_status_txt.innerText = "Muted";
            mic_icon_closed.style.display = "block";
            mic_icon_open.style.display = "none";
        }
      }

      function sendAudio(base64data) {
        const mode = rb_local.checked ? "local" : "cloud";
        const lang = document.querySelector('input[name="rb_lang"]:checked').id.replace("rb_", "");

        socket.emit("process_request", {
            audio: base64data,
            mode: mode,
            language: lang === "auto" ? null : lang
        });

        system_status.innerText = "Sending audio...";
        spinner_cont.style.display = "flex";
        transcription.value = "";
        llm_response.value = "";
      }
    </script>
  </body>
</html>
